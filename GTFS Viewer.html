<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GTFS Viewer</title>
  <style>
    :root { --bg:#0b0f14; --card:#121821; --muted:#8fa3b8; --text:#e7edf3; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial;background:radial-gradient(1200px 1200px at 10% -10%,rgba(77,163,255,.08),transparent),radial-gradient(1000px 800px at 110% 10%,rgba(34,211,238,.08),transparent),var(--bg);color:var(--text);min-height:100vh}
    header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.2px}
    .tabs{display:flex;flex-direction:column;gap:12px;align-items:flex-start;width:100%}
    .tab-header{display:flex;justify-content:space-between;align-items:center;gap:16px;width:100%;flex-wrap:wrap}
    .tab-header-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .tab-about{display:flex;align-items:center}
    .tab-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .tab-group{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
    .tab-group-label{font-size:11px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--muted);opacity:.8}
    .tab-btn{appearance:none;background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer;transition:.15s ease;font-weight:600}
    .tab-btn.active{background:linear-gradient(135deg,rgba(77,163,255,.12),rgba(34,211,238,.12));color:#e7edf3;border-color:#2a3a4d}
    .container{padding:20px 24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0));border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .file-box{display:grid;gap:14px}
    label{color:var(--muted);font-weight:600}
    input[type=file]{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }
    .hint{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f1520;color:var(--text);cursor:pointer}
    .btn.primary{border-color:#2a3a4d;background:linear-gradient(135deg,rgba(77,163,255,.14),rgba(34,211,238,.14))}
    .file-trigger{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .file-trigger .btn{min-width:140px;justify-content:center;display:inline-flex;font-weight:600}
    .fail-box{margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(229,62,62,.3);background:rgba(229,62,62,.08);}
    .fail-box h3{margin:0 0 8px;font-size:13px;color:#fca5a5;letter-spacing:.2px}
    .fail-box ul{margin:0;padding-left:18px;font-size:12px;color:#f8d7da;display:grid;gap:4px}
    .content{display:none}
    .content.active{display:block}
    table{border-collapse:collapse;width:100%;white-space:nowrap}
    thead th{position:sticky;top:0;background:#0f1520}
    th,td{border-bottom:1px solid #1c2430;padding:8px 10px;text-align:left}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable .header-inner{display:inline-flex;align-items:center;gap:6px}
    th.sortable .sort-indicator{font-size:10px;opacity:.4;transition:.15s ease}
    th.sortable.sort-active .sort-indicator{opacity:1;color:#7bb8ff}
    tbody tr:hover{background:rgba(255,255,255,0.03)}
    .scroll{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#0f1520}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f1520;border:1px solid var(--border);color:#8fa3b8;font-size:12px}
    .file-pill{margin-top:6px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#c7d2fe}
    /* Filters & pagination */
    .filters th{background:#0b1420;position:sticky;top:32px;z-index:1}
    .filter-input{width:100%;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#0f1520;color:var(--text);font-size:12px}
    .filter-input::placeholder{color:#6b7b8f}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .pagination{display:flex;align-items:center;gap:6px}
    .pagination .btn{padding:6px 10px}
    .select{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0f1520;color:var(--text)}
    /* Color chips */
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#0f1520}
    .chip-swatch{width:14px;height:14px;border-radius:4px;border:1px solid #0003}
    .modal{position:fixed;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;padding:24px;background:rgba(8,13,20,.65);backdrop-filter:blur(4px)}
    .modal[hidden]{display:none}
    .modal-dialog{position:relative;max-width:520px;width:100%;background:linear-gradient(180deg,rgba(17,24,39,.95),rgba(17,24,39,.9));border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 18px 45px rgba(0,0,0,.35);overflow:auto;max-height:90vh}
    .modal-dialog h2{margin-top:0;margin-bottom:16px;font-size:18px}
    .modal-close{position:absolute;top:14px;right:14px;background:transparent;border:1px solid transparent;color:var(--muted);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;line-height:1;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:rgba(255,255,255,.05);color:var(--text)}
    .about-body p{margin:0 0 12px;line-height:1.6;color:var(--muted)}
    .about-body p strong{color:var(--text)}
    .about-body a{color:#7bb8ff;text-decoration:none}
    .about-body a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="tabs" id="tabs"></div>
  </header>

  <main class="container">
    <section id="home" class="content active">
      <div class="card">
        <h2 style="margin-top:0">Home</h2>
        <p>Import <strong>GTFS files</strong> and visualize its data.<br />The <strong>Simple trip table</strong> appears next to Home only when <span class="kbd">trips.txt</span>, <span class="kbd">stop_times.txt</span>, and <span class="kbd">routes.txt</span> are loaded.
        <div class="file-box" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
          <label for="fileInput">Select GTFS files (.txt, .csv, .zip)</label>
          <input id="fileInput" type="file" accept=".txt,.csv,.zip" multiple />
          <div class="file-trigger">
            <button class="btn primary" id="chooseBtn" type="button">Choose files</button>
            <span class="hint">You can also drag & drop files anywhere in this panel.</span>
          </div>
          <div class="hint">GTFS ZIP bundles are supported. Tabs: Agency, Calendar, Calendar dates, Fare attributes, Fare rules, Frequencies, Routes, Shapes, Stop times, Stops, Transfers, Trips, and Simple trip table (derived). URLs become clickable; color fields render as swatches.</div>
          <div class="actions">
            <button class="btn primary" id="importBtn">Import</button>
            <button class="btn" id="clearBtn" title="Clear tables & start over">Clear</button>
          </div>
          <div id="selectedFiles"></div>
          <div id="failedFiles" class="fail-box" hidden>
            <h3>Failed to upload</h3>
            <ul id="failedFilesList"></ul>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-simple" class="content"></section>
    <section id="tab-agency" class="content"></section>
    <section id="tab-calendar" class="content"></section>
    <section id="tab-calendar_dates" class="content"></section>
    <section id="tab-fare_attributes" class="content"></section>
    <section id="tab-fare_rules" class="content"></section>
    <section id="tab-frequencies" class="content"></section>
    <section id="tab-routes" class="content"></section>
    <section id="tab-shapes" class="content"></section>
    <section id="tab-stop_times" class="content"></section>
    <section id="tab-stops" class="content"></section>
  <section id="tab-transfers" class="content"></section>
  <section id="tab-trips" class="content"></section>
</main>

<div id="aboutModal" class="modal" hidden role="dialog" aria-modal="true" aria-labelledby="aboutTitle" tabindex="-1">
  <div class="modal-dialog">
    <button type="button" class="modal-close" aria-label="Close About dialog">×</button>
    <div class="about-body">
      <h2 id="aboutTitle">About</h2>
      <p><strong>GTFS Viewer (Pure HTML)</strong><br />A lightweight tool to quickly inspect static GTFS feeds directly in your browser — no server or installation required.</p>
      <p><strong>About the project:</strong><br />You can fork this project on GitHub to make your own version.<br />Official repository: <a href="https://github.com/vitorstanzione/GTFS-Viewer" target="_blank" rel="noopener noreferrer">github.com/vitorstanzione/GTFS-Viewer</a></p>
      <p><strong>License:</strong><br />This project is public domain (The Unlicense).<br />You can copy or modify it freely in your own copy.</p>
      <p><strong>Credits:</strong><br />Created with ❤️ by <a href="https://www.linkedin.com/in/vitorstanzione/" target="_blank" rel="noopener noreferrer">Vítor Stanzione</a>, using <strong>OpenAI Codex</strong>,<br />on <strong>October 30, 2025</strong>.</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    // ===== Elements & state =====
    const tabsEl = document.getElementById('tabs');
    const simpleEl = document.getElementById('tab-simple');

    const FILE_DEFS = [
      { file:'agency.txt', key:'agency', label:'Agency' },
      { file:'calendar.txt', key:'calendar', label:'Calendar' },
      { file:'calendar_dates.txt', key:'calendar_dates', label:'Calendar dates' },
      { file:'fare_attributes.txt', key:'fare_attributes', label:'Fare attributes' },
      { file:'fare_rules.txt', key:'fare_rules', label:'Fare rules' },
      { file:'frequencies.txt', key:'frequencies', label:'Frequencies' },
      { file:'routes.txt', key:'routes', label:'Routes' },
      { file:'shapes.txt', key:'shapes', label:'Shapes' },
      { file:'stop_times.txt', key:'stop_times', label:'Stop times' },
      { file:'stops.txt', key:'stops', label:'Stops' },
      { file:'transfers.txt', key:'transfers', label:'Transfers' },
      { file:'trips.txt', key:'trips', label:'Trips' }
    ];

    const containers = FILE_DEFS.reduce((acc, def) => {
      const el = document.getElementById(`tab-${def.key}`);
      if (el) acc[def.key] = el;
      return acc;
    }, {});

    const FRIENDLY = { home:'Home', simple:'Simple trip table' };
    FILE_DEFS.forEach(def => { FRIENDLY[def.key] = def.label; });

    const FILES_BY_NAME = FILE_DEFS.reduce((acc, def) => {
      acc[def.file] = def;
      if (def.file.endsWith('.txt')) {
        acc[def.file.replace(/\.txt$/, '.csv')] = def;
      }
      return acc;
    }, {});

    const SIMPLE_REQUIRED = ['trips','stop_times','routes'];

    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const importBtn = document.getElementById('importBtn');
    const clearBtn = document.getElementById('clearBtn');
    const selectedFilesEl = document.getElementById('selectedFiles');
    const failedFilesEl = document.getElementById('failedFiles');
    const failedFilesList = document.getElementById('failedFilesList');

    let stagedFiles = [];
    let parsedData = {};
    let failedImports = [];
    let lastLoadedKey = null;

    // ===== Tabs =====
    function createTabButton(def, activeId) {
      const button = document.createElement('button');
      button.className = 'tab-btn' + (def.target === activeId ? ' active' : '');
      button.textContent = def.label;
      button.addEventListener('click', () => showContent(def.target));
      return button;
    }

    function setTabs(activeId) {
      tabsEl.innerHTML = '';

      const baseDefs = [{ id:'home', label:FRIENDLY.home, target:'home' }];
      if (simpleEl.dataset.loaded === 'true') {
        baseDefs.push({ id:'simple', label:FRIENDLY.simple, target:'tab-simple' });
      }

      const importedDefs = FILE_DEFS
        .filter(def => containers[def.key]?.dataset.loaded === 'true')
        .map(def => ({ id:def.key, label:def.label, target:`tab-${def.key}` }));

      const headerRow = document.createElement('div');
      headerRow.className = 'tab-header';

      const primaryRow = document.createElement('div');
      primaryRow.className = 'tab-header-left';
      const title = document.createElement('h1');
      title.textContent = 'GTFS Viewer';
      primaryRow.appendChild(title);
      baseDefs.forEach(def => primaryRow.appendChild(createTabButton(def, activeId)));

      const aboutWrap = document.createElement('div');
      aboutWrap.className = 'tab-about';
      const aboutButton = document.createElement('button');
      aboutButton.type = 'button';
      aboutButton.className = 'tab-btn';
      aboutButton.textContent = 'About';
      aboutButton.addEventListener('click', openAboutModal);
      aboutWrap.appendChild(aboutButton);

      headerRow.append(primaryRow, aboutWrap);
      tabsEl.appendChild(headerRow);

      if (importedDefs.length) {
        const group = document.createElement('div');
        group.className = 'tab-group';
        const label = document.createElement('div');
        label.className = 'tab-group-label';
        const row = document.createElement('div');
        row.className = 'tab-row';
        importedDefs.forEach(def => row.appendChild(createTabButton(def, activeId)));
        group.append(label, row);
        tabsEl.appendChild(group);
      }
    }

    function showContent(id) {
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
      setTabs(id);
    }

    const aboutModal = document.getElementById('aboutModal');
    const aboutClose = aboutModal?.querySelector('.modal-close');

    function openAboutModal(){ if (aboutModal){ aboutModal.hidden = false; aboutModal.focus(); } }
    function closeAboutModal(){ if (aboutModal){ aboutModal.hidden = true; } }

    aboutClose?.addEventListener('click', closeAboutModal);
    aboutModal?.addEventListener('click', event => {
      if (event.target === aboutModal) closeAboutModal();
    });
    document.addEventListener('keydown', event => {
      if (event.key === 'Escape' && !aboutModal?.hidden){
        closeAboutModal();
      }
    });

    // ===== File handling =====
    function handleDrop(ev) { ev.preventDefault(); stagedFiles = Array.from(ev.dataTransfer.files||[]); renderSelectedFiles(); }
    if (chooseBtn) chooseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => { stagedFiles = Array.from(fileInput.files||[]); renderSelectedFiles(); });
    importBtn.addEventListener('click', async () => { if (!stagedFiles.length) { alert('Please select GTFS files to import.'); return; } await importSelectedFiles(stagedFiles); });
    clearBtn.addEventListener('click', () => {
      stagedFiles=[]; fileInput.value=''; selectedFilesEl.innerHTML='';
      Object.values(containers).forEach(el=>{ el.innerHTML=''; delete el.dataset.loaded; });
      if (simpleEl){ simpleEl.innerHTML=''; delete simpleEl.dataset.loaded; }
      parsedData={}; failedImports=[]; lastLoadedKey=null; renderFailedFiles(failedImports); showContent('home');
    });

    function renderSelectedFiles(){ if (!stagedFiles.length){ selectedFilesEl.innerHTML=''; return;} selectedFilesEl.innerHTML = stagedFiles.map(f=>`<span class="pill file-pill">${f.name}<span style="opacity:.6">${formatSize(f.size)}</span></span>`).join(' '); }
    function formatSize(bytes){ if(bytes<1024)return `${bytes} B`; const kb=bytes/1024; if(kb<1024)return `${kb.toFixed(1)} KB`; const mb=kb/1024; return `${mb.toFixed(2)} MB`; }

    function renderFailedFiles(files){
      if (!failedFilesEl || !failedFilesList) return;
      failedFilesList.innerHTML='';
      if (!files.length){ failedFilesEl.hidden=true; return; }
      failedFilesEl.hidden=false;
      const frag=document.createDocumentFragment();
      files.forEach(item=>{
        const li=document.createElement('li');
        const nameSpan=document.createElement('span');
        nameSpan.textContent=item.name;
        li.appendChild(nameSpan);
        if (item.reason){
          const reasonSpan=document.createElement('span');
          reasonSpan.textContent=` — ${item.reason}`;
          reasonSpan.style.opacity='0.75';
          li.appendChild(reasonSpan);
        }
        frag.appendChild(li);
      });
      failedFilesList.appendChild(frag);
    }

    async function importSelectedFiles(files){
      const pending = [];
      const failed = [];
      for (const file of files){
        const lower = file.name.toLowerCase();
        if (lower.endsWith('.zip')) {
          try {
            const entries = await extractFilesFromZip(file);
            pending.push(...entries);
          } catch (err) {
            console.error('Failed to read ZIP', file.name, err);
            alert(`Unable to read ZIP file: ${file.name}`);
            failed.push({ name:file.name, reason:'Unable to read ZIP archive' });
          }
        } else {
          try {
            const text = await readFile(file);
            pending.push({ name:file.name, lowerName:lower, text });
          } catch (err) {
            console.error('Failed to read file', file.name, err);
            failed.push({ name:file.name, reason:'Unable to read file' });
          }
        }
      }

      let lastImportedKey = null;
      for (const entry of pending){
        const name = entry.lowerName;
        let consumed=false;
        const def = FILES_BY_NAME[name];
        if (def && containers[def.key]) {
          const parsed = parseCSV(entry.text);
          parsedData[def.key] = parsed;
          renderDataTable(containers[def.key], parsed.headers, parsed.rows, def.label);
          containers[def.key].dataset.loaded='true';
          lastImportedKey = def.key;
          consumed=true;
        } else {
          console.warn('Ignoring file:', entry.name);
        }
        if (!consumed){ failed.push({ name:entry.name, reason:'Unsupported file' }); }
      }
      if (lastImportedKey) {
        lastLoadedKey = lastImportedKey;
      }
      failedImports = failed;
      renderFailedFiles(failedImports);
      const simpleReady = SIMPLE_REQUIRED.every(key => containers[key]?.dataset.loaded==='true');
      if (simpleReady) {
        buildAndRenderSimpleTable();
        showContent('tab-simple');
      } else {
        const fallbackKey = lastImportedKey || lastLoadedKey;
        if (fallbackKey) {
          showContent(`tab-${fallbackKey}`);
        } else {
          showContent('home');
        }
      }
    }

    function readFile(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsText(file); }); }
    function readFileAsArrayBuffer(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsArrayBuffer(file); }); }

    async function extractFilesFromZip(file){
      const buffer = await readFileAsArrayBuffer(file);
      const zip = await JSZip.loadAsync(buffer);
      const tasks = [];
      let order = 0;
      zip.forEach((relativePath, entry) => {
        if (entry.dir) return;
        const baseName = relativePath.split('/').pop();
        if (!baseName) return;
        const lowerName = baseName.toLowerCase();
        if (!lowerName.endsWith('.txt') && !lowerName.endsWith('.csv')) return;
        const currentOrder = order++;
        tasks.push(entry.async('string').then(text => ({ order:currentOrder, name:baseName, lowerName, text })));
      });
      const resolved = await Promise.all(tasks);
      return resolved.sort((a,b)=>a.order-b.order).map(({ order, ...rest }) => rest);
    }

    // ===== CSV parser (handles quotes, escaped quotes, CRLF) =====
    function parseCSV(text){
      text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      const rows=[]; let cur=''; let inQ=false; let row=[];
      for (let i=0;i<text.length;i++){
        const ch=text[i];
        if (ch==='"') { if(inQ && text[i+1]==='"'){ cur+='"'; i++; continue; } inQ=!inQ; continue; }
        if (ch===',' && !inQ){ row.push(cur); cur=''; continue; }
        if (ch==='\n' && !inQ){ row.push(cur); cur=''; if(row.length && !(row.length===1 && row[0]==='')) rows.push(row); row=[]; continue; }
        cur+=ch;
      }
      if (cur.length||row.length){ row.push(cur); rows.push(row); }
      if (!rows.length) return { headers:[], rows:[] };
      const headers=rows.shift();
      const norm=rows.map(r=> r.length<headers.length ? [...r, ...Array(headers.length-r.length).fill('')] : r);
      return { headers, rows:norm };
    }

    // ===== Generic table with filters + pagination + rendering =====
    function createState(headers, rows){ return { headers, rows, filters: headers.map(()=>''), page:1, pageSize:50, sortColumn:null, sortDirection:'asc' }; }
    function applyFilters(rows, headers, filters){ const f=filters.map(v=>{v=(v||'').trim(); return !v?{m:'none'}:v.startsWith('=')?{m:'eq',v:v.slice(1).toLowerCase()}:{m:'in',v:v.toLowerCase()};}); return rows.filter(r=>r.every((c,i)=>{const fl=f[i]; if(fl.m==='none')return true; const s=String(c||'').toLowerCase(); return fl.m==='eq'? s===fl.v : s.includes(fl.v);})); }
    function paginate(rows,page,pageSize){ const total=rows.length; const pages=Math.max(1,Math.ceil(total/pageSize)); const p=Math.min(Math.max(1,page),pages); const start=(p-1)*pageSize; return { pageRows: rows.slice(start,start+pageSize), page:p, pages, total }; }
    function mkBtn(t){ const b=document.createElement('button'); b.className='btn'; b.type='button'; b.textContent=t; return b; }
    function isValidHex6(v){ return /^[#]?[0-9a-fA-F]{6}$/.test(String(v||'')); }
    function normalizeHex(v){ v=String(v||'').trim(); return v? (v.startsWith('#')? v : '#'+v) : ''; }

    function sanitizeFileName(name){
      const base=String(name||'data').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      return base || 'data';
    }
    function rowsToCSV(headers, rows){
      const allRows=[headers, ...rows];
      return allRows.map(row=>row.map(cell=>{
        const value=String(cell??'');
        return /[",\n]/.test(value) ? '"'+value.replace(/"/g,'""')+'"' : value;
      }).join(',')).join('\n');
    }
    function rowsToJSON(headers, rows){
      const objects=rows.map(row=>{
        const obj={};
        headers.forEach((h,idx)=>{ obj[h]=row[idx]??''; });
        return obj;
      });
      return JSON.stringify(objects,null,2);
    }
    function downloadTextFile(filename, text, mime){
      const blob=new Blob([text],{ type:(mime||'text/plain')+';charset=utf-8' });
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url;
      link.download=filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(()=>URL.revokeObjectURL(url),0);
    }
    function copyToClipboard(text){
      if (navigator.clipboard?.writeText){
        return navigator.clipboard.writeText(text);
      }
      return new Promise((resolve,reject)=>{
        const textarea=document.createElement('textarea');
        textarea.value=text;
        textarea.style.position='fixed';
        textarea.style.top='-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
          document.execCommand('copy');
          resolve();
        } catch (err) {
          reject(err);
        } finally {
          document.body.removeChild(textarea);
        }
      });
    }

    function renderDataTable(container, headers, rows, title){
      container.innerHTML=''; const state=createState(headers,rows); container.__state=state;
      const card=document.createElement('div'); card.className='card';
      const headerBar=document.createElement('div'); headerBar.className='toolbar';
      const titleEl=document.createElement('h2'); titleEl.style.margin='0'; titleEl.textContent=title;
      const countEl=document.createElement('span'); countEl.className='pill'; countEl.textContent=`${rows.length.toLocaleString()} rows`;
      const exportWrap=document.createElement('div'); exportWrap.className='actions';
      const exportSelect=document.createElement('select'); exportSelect.className='select'; exportSelect.setAttribute('aria-label','Export data');
      const placeholderOption=document.createElement('option'); placeholderOption.value=''; placeholderOption.textContent='Export to...'; placeholderOption.selected=true; placeholderOption.disabled=true; placeholderOption.hidden=true; exportSelect.appendChild(placeholderOption);
      [
        { value:'csv', label:'CSV' },
        { value:'json', label:'JSON' },
        { value:'clipboard', label:'Clipboard' }
      ].forEach(opt=>{ const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label; exportSelect.appendChild(o); });
      const exportMessage=document.createElement('span'); exportMessage.className='pill'; exportMessage.hidden=true;
      exportWrap.append(exportSelect,exportMessage);
      const spacer=document.createElement('div'); spacer.className='spacer';
      const pageSizeSel=document.createElement('select'); pageSizeSel.className='select'; [25,50,100,250,1000].forEach(n=>{const o=document.createElement('option'); o.value=String(n); o.textContent=`${n}/page`; pageSizeSel.appendChild(o);}); pageSizeSel.value=String(state.pageSize);
      const pager=document.createElement('div'); pager.className='pagination';
      const btnFirst=mkBtn('⏮'), btnPrev=mkBtn('◀'), pageInfo=document.createElement('span'), btnNext=mkBtn('▶'), btnLast=mkBtn('⏭'); pageInfo.className='pill';
      pager.append(btnFirst,btnPrev,pageInfo,btnNext,btnLast);
      headerBar.append(titleEl,countEl,exportWrap,spacer,pageSizeSel,pager);
      const scroller=document.createElement('div'); scroller.className='scroll';
      const table=document.createElement('table');
      const thead=document.createElement('thead'); const trHead=document.createElement('tr'); const headerCells=[]; headers.forEach((h,idx)=>{ const th=document.createElement('th'); th.classList.add('sortable'); th.setAttribute('aria-sort','none'); const inner=document.createElement('span'); inner.className='header-inner'; const label=document.createElement('span'); label.textContent=h; const indicator=document.createElement('span'); indicator.className='sort-indicator'; indicator.textContent=''; inner.append(label,indicator); th.appendChild(inner); th.addEventListener('click',()=>{ if(state.sortColumn===idx){ state.sortDirection=state.sortDirection==='asc'?'desc':'asc'; } else { state.sortColumn=idx; state.sortDirection='asc'; } state.page=1; draw(); }); headerCells.push({th,indicator}); trHead.appendChild(th); }); thead.appendChild(trHead);
      const trFilters=document.createElement('tr'); trFilters.className='filters'; headers.forEach((h,idx)=>{ const th=document.createElement('th'); const input=document.createElement('input'); input.className='filter-input'; input.type='text'; input.placeholder='Filter'; input.value=state.filters[idx]; input.addEventListener('input',()=>{ state.filters[idx]=input.value; state.page=1; draw(); }); th.appendChild(input); trFilters.appendChild(th); }); thead.appendChild(trFilters);
      const tbody=document.createElement('tbody'); table.appendChild(thead); table.appendChild(tbody); scroller.appendChild(table); card.appendChild(headerBar); card.appendChild(scroller); container.appendChild(card);

      function computeActiveRows(){
        const filteredRows=applyFilters(state.rows,state.headers,state.filters);
        let workingRows=filteredRows;
        if (Number.isInteger(state.sortColumn)){
          const idx=state.sortColumn;
          const dir=state.sortDirection==='desc'?-1:1;
          workingRows=[...filteredRows].sort((a,b)=>{
            const av=a[idx]??'';
            const bv=b[idx]??'';
            return dir*String(av).localeCompare(String(bv),undefined,{numeric:true,sensitivity:'base'});
          });
        }
        state.filteredRows=filteredRows;
        state.workingRows=workingRows;
        return { filteredRows, workingRows };
      }

      function draw(){
        const { filteredRows, workingRows } = computeActiveRows();
        const {pageRows,page,pages}=paginate(workingRows,state.page,state.pageSize); state.page=page;
        tbody.innerHTML=''; const frag=document.createDocumentFragment();
        pageRows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach((cell,idx)=>{ const td=document.createElement('td'); const header=state.headers[idx]||''; const val=String(cell||'');
          if (/url/i.test(header) && /^https?:\/\//i.test(val)) { const a=document.createElement('a'); a.href=val; a.textContent=val; a.target='_blank'; a.rel='noopener noreferrer'; td.appendChild(a); }
          else if (/color/i.test(header) && isValidHex6(val)) { const chip=document.createElement('span'); chip.className='chip'; const sw=document.createElement('span'); sw.className='chip-swatch'; sw.style.background=normalizeHex(val); const tx=document.createElement('span'); tx.textContent=val.replace(/^#/,'').toUpperCase(); if (/route_text_color/i.test(header)) tx.style.color=normalizeHex(val); chip.appendChild(sw); chip.appendChild(tx); td.appendChild(chip); }
          else { td.textContent=val; if (/(?:_id$)|^(?:\d{1,2}:\d{2}:\d{2})$/.test(header)) td.style.fontFamily='ui-monospace,SFMono-Regular,Menlo,Consolas,monospace'; }
          tr.appendChild(td); }); frag.appendChild(tr); });
        tbody.appendChild(frag); pageInfo.textContent=`Page ${page} / ${pages}`; countEl.textContent=`${filteredRows.length.toLocaleString()} rows`;
        headerCells.forEach(({th,indicator},idx)=>{
          const isActive=state.sortColumn===idx;
          th.classList.toggle('sort-active',isActive);
          th.setAttribute('aria-sort',isActive ? (state.sortDirection==='asc'?'ascending':'descending') : 'none');
          if (!isActive){ indicator.textContent=''; return; }
          indicator.textContent=state.sortDirection==='asc'?'▲':'▼';
        });
        btnFirst.disabled=page<=1; btnPrev.disabled=page<=1; btnNext.disabled=page>=pages; btnLast.disabled=page>=pages;
      }
      pageSizeSel.addEventListener('change',()=>{ state.pageSize=parseInt(pageSizeSel.value,10); state.page=1; draw(); });
      btnFirst.addEventListener('click',()=>{ state.page=1; draw(); }); btnPrev.addEventListener('click',()=>{ state.page=Math.max(1,state.page-1); draw(); }); btnNext.addEventListener('click',()=>{ state.page=state.page+1; draw(); }); btnLast.addEventListener('click',()=>{ const { filteredRows } = computeActiveRows(); state.page=Math.max(1,Math.ceil(filteredRows.length/state.pageSize)); draw(); });
      function prepareExportRows(){
        const { workingRows } = computeActiveRows();
        return workingRows;
      }
      function showExportMessage(text, timeout=2000){
        exportMessage.textContent=text;
        exportMessage.hidden=false;
        if (timeout){
          clearTimeout(exportMessage._hideTimer);
          exportMessage._hideTimer=setTimeout(()=>{ exportMessage.hidden=true; },timeout);
        }
      }
      exportSelect.addEventListener('change',()=>{
        const { value } = exportSelect;
        if (!value) return;
        const activeRows=prepareExportRows();
        if (value==='csv'){
          const csv=rowsToCSV(state.headers,activeRows);
          const fileName=`${sanitizeFileName(title)}.csv`;
          downloadTextFile(fileName,csv,'text/csv');
          showExportMessage('CSV download started');
        } else if (value==='json'){
          const json=rowsToJSON(state.headers,activeRows);
          const fileName=`${sanitizeFileName(title)}.json`;
          downloadTextFile(fileName,json,'application/json');
          showExportMessage('JSON download started');
        } else if (value==='clipboard'){
          const csv=rowsToCSV(state.headers,activeRows);
          copyToClipboard(csv)
            .then(()=>{ showExportMessage('Copied CSV to clipboard'); })
            .catch(()=>{ showExportMessage('Copy failed',3000); });
        }
        exportSelect.selectedIndex=0;
      });
      draw();
    }

    // ===== Simple Trip Table =====
    function buildAndRenderSimpleTable(){
      const trips = parsedData.trips;
      const stopTimes = parsedData.stop_times;
      const routes = parsedData.routes;
      if (!trips || !stopTimes || !routes) {
        if (simpleEl){ simpleEl.innerHTML=''; delete simpleEl.dataset.loaded; }
        return;
      }
      const tH = trips.headers, tR = trips.rows;
      const sH = stopTimes.headers, sR = stopTimes.rows;
      const rH = routes.headers, rR = routes.rows;

      const IDX = {
        trips: { route_id: tH.indexOf('route_id'), trip_id: tH.indexOf('trip_id') },
        stop_times: { trip_id: sH.indexOf('trip_id'), arrival_time: sH.indexOf('arrival_time'), departure_time: sH.indexOf('departure_time'), stop_id: sH.indexOf('stop_id'), stop_sequence: sH.indexOf('stop_sequence') },
        routes: { route_id: rH.indexOf('route_id'), route_short_name: rH.indexOf('route_short_name') }
      };

      // Build stop summaries per trip (origin/destination)
      const byTrip = new Map();
      for (const row of sR){
        const tripId=row[IDX.stop_times.trip_id]; const seq=Number(row[IDX.stop_times.stop_sequence]||0);
        const arr=row[IDX.stop_times.arrival_time]; const dep=row[IDX.stop_times.departure_time]; const stop=row[IDX.stop_times.stop_id];
        if (!byTrip.has(tripId)) byTrip.set(tripId,{ minSeq:seq, maxSeq:seq, origin:{stop_id:stop, dep_time:dep}, dest:{stop_id:stop, arr_time:arr} });
        const rec=byTrip.get(tripId);
        if (seq<rec.minSeq){ rec.minSeq=seq; rec.origin={stop_id:stop, dep_time:dep}; }
        if (seq>rec.maxSeq){ rec.maxSeq=seq; rec.dest={stop_id:stop, arr_time:arr}; }
      }

      // route_id => route_short_name map
      const routeShort = new Map();
      for (const rr of rR){ routeShort.set(rr[IDX.routes.route_id], rr[IDX.routes.route_short_name]||''); }

      const simpleHeaders=['Trip ID','Route ID','Sign (route_short_name)','Origin Stop ID','Destination Stop ID','Departure Time','Arrival Time'];
      const simpleRows=[];
      for (const row of tR){
        const routeId=row[IDX.trips.route_id]; const tripId=row[IDX.trips.trip_id];
        const sign=routeShort.get(routeId)||''; const times=byTrip.get(tripId)||{origin:{stop_id:'',dep_time:''},dest:{stop_id:'',arr_time:''}};
        simpleRows.push([tripId, routeId, sign, times.origin.stop_id||'', times.dest.stop_id||'', times.origin.dep_time||'', times.dest.arr_time||'']);
      }
      renderDataTable(simpleEl, simpleHeaders, simpleRows, FRIENDLY.simple);
      simpleEl.dataset.loaded='true'; setTabs('tab-simple');
    }

    // ===== Init =====
    setTabs('home');
  </script>
</body>

</html>



